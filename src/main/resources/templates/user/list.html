<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/header}">
<head>
    <title>Управление пользователями - Админ панель</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Header -->
    <section class="py-4 bg-light">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h2 mb-0">
                        <i class="fas fa-users me-2"></i>Управление пользователями
                    </h1>
                    <p class="text-muted mb-0">Управление пользователями и их ролями</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="exportUsersBtn">
                            <i class="fas fa-download me-2"></i>Экспорт
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Users Management -->
    <section class="py-5">
        <div class="container">
            <!-- Search and Filters -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Поиск пользователей..."
                               id="searchInput" th:value="${search}">
                        <button class="btn btn-outline-primary" type="button" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="roleFilter">
                        <option value="">Все роли</option>
                        <option value="ROLE_USER">Пользователь</option>
                        <option value="ROLE_MANAGER">Менеджер</option>
                        <option value="ROLE_ADMIN">Администратор</option>
                    </select>
                </div>
            </div>

            <!-- Users Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Пользователь</th>
                                        <th>Email</th>
                                        <th>Телефон</th>
                                        <th>Роль</th>
                                        <th>Статус</th>
                                        <th>Дата регистрации</th>
                                        <th style="width: 200px;">Действия</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="user : ${users.content}">
                                        <td th:text="${user.id}">1</td>
                                        <td>
                                            <strong th:text="${user.firstName + ' ' + user.lastName}">
                                                Иван Иванов
                                            </strong>
                                            <br>
                                            <small class="text-muted" th:text="${user.username}">
                                                username
                                            </small>
                                        </td>
                                        <td th:text="${user.email}">user@example.com</td>
                                        <td th:text="${user.phoneNumber ?: 'Не указан'}">+7 (999) 123-45-67</td>
                                        <td>
                                            <span th:each="role : ${user.roles}" th:class="${'badge ' + (role.name.name() == 'ROLE_ADMIN' ? 'bg-danger' : (role.name.name() == 'ROLE_MANAGER' ? 'bg-warning' : 'bg-primary'))}" th:text="${role.name.name() == 'ROLE_ADMIN' ? 'Админ' : (role.name.name() == 'ROLE_MANAGER' ? 'Менеджер' : 'Пользователь')}" class="badge me-1">
                                                USER
                                            </span>
                                        </td>
                                        <td>
                                                    <span th:if="${user.deleted}"
                                                          class="badge bg-danger">Удален</span>
                                            <span th:unless="${user.deleted}"
                                                  class="badge bg-success">Активен</span>
                                        </td>
                                        <td>
                                            <small th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy')}">
                                                01.01.2024
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary change-role-btn"
                                                        th:data-user-id="${user.id}"
                                                        title="Изменить роль">
                                                    <i class="fas fa-user-cog"></i>
                                                </button>
                                                <button th:if="${!user.deleted}"
                                                        class="btn btn-outline-danger delete-user-btn"
                                                        th:data-user-id="${user.id}"
                                                        title="Удалить">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <button th:if="${user.deleted}"
                                                        class="btn btn-outline-success restore-user-btn"
                                                        th:data-user-id="${user.id}"
                                                        title="Восстановить">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="row mt-4" th:if="${users.totalPages > 1}">
                <div class="col">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${users.first} ? 'disabled' : ''">
                                <a class="page-link" th:href="@{/admin/users(page=0)}">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item" th:classappend="${users.first} ? 'disabled' : ''">
                                <a class="page-link" th:href="@{/admin/users(page=${users.number - 1})}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>

                            <li th:each="page : ${#numbers.sequence(0, users.totalPages - 1)}"
                                class="page-item"
                                th:classappend="${page == users.number} ? 'active' : ''">
                                <a class="page-link"
                                   th:href="@{/admin/users(page=${page})}"
                                   th:text="${page + 1}">1</a>
                            </li>

                            <li class="page-item" th:classappend="${users.last} ? 'disabled' : ''">
                                <a class="page-link" th:href="@{/admin/users(page=${users.number + 1})}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item" th:classappend="${users.last} ? 'disabled' : ''">
                                <a class="page-link" th:href="@{/admin/users(page=${users.totalPages - 1})}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const roleFilter = document.getElementById('roleFilter');

        searchButton.addEventListener('click', performSearch);
        roleFilter.addEventListener('change', performSearch);

        function performSearch() {
            const query = searchInput.value.trim();
            const role = roleFilter.value;

            let url = '/flowershop/admin/users?';
            const params = [];

            if (query) params.push(`search=${encodeURIComponent(query)}`);
            if (role) params.push(`role=${role}`);

            window.location.href = url + params.join('&');
        }

        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Change role
        document.querySelectorAll('.change-role-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                changeUserRole(userId);
            });
        });

        // Delete user
        document.querySelectorAll('.delete-user-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                deleteUser(userId);
            });
        });

        // Restore user
        document.querySelectorAll('.restore-user-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                restoreUser(userId);
            });
        });

        function changeUserRole(userId) {
            console.log('changeUserRole called with userId:', userId);

            const newRole = prompt('Введите новую роль (ROLE_USER, ROLE_MANAGER, ROLE_ADMIN):');
            console.log('User entered role:', newRole);

            if (newRole && ['ROLE_USER', 'ROLE_MANAGER', 'ROLE_ADMIN'].includes(newRole)) {
                const url = `/api/users/${userId}/role?role=${newRole}`;
                console.log('Making request to:', url);

                fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        showAlert('Роль пользователя изменена', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showAlert('Ошибка при изменении роли: ' + (data.message || 'Неизвестная ошибка'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Ошибка при изменении роли: ' + error.message, 'error');
                });
            } else if (newRole) {
                showAlert('Неверная роль. Допустимые значения: ROLE_USER, ROLE_MANAGER, ROLE_ADMIN', 'error');
            }
        }

        function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) return;

            fetch(`/api/users/${userId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Пользователь удален', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('Ошибка при удалении пользователя', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Ошибка при удалении пользователя', 'error');
            });
        }

        function restoreUser(userId) {
            fetch(`/api/users/${userId}/restore`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Пользователь восстановлен', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert('Ошибка при восстановлении пользователя', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Ошибка при восстановлении пользователя', 'error');
            });
        }

        // Export users
        document.getElementById('exportUsersBtn').addEventListener('click', function() {
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        exportToCSV(data.data.content, 'users_export.csv');
                    } else {
                        showAlert('Ошибка при экспорте данных', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Ошибка при экспорте данных', 'error');
                });
        });

        function exportToCSV(data, filename) {
            const csvContent = convertToCSV(data);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = ['ID', 'Имя', 'Фамилия', 'Email', 'Телефон', 'Роль', 'Статус', 'Дата регистрации'];
            const csvRows = [];

            // Add headers
            csvRows.push(headers.join(','));

            // Add data rows
            for (const user of data) {
                const values = [
                    user.id,
                    `"${user.firstName}"`,
                    `"${user.lastName}"`,
                    user.email,
                    user.phoneNumber || '',
                    user.roles?.map(role => role.name).join(', ') || '',
                    user.deleted ? 'Удален' : 'Активен',
                    user.createdAt ? new Date(user.createdAt).toLocaleDateString() : ''
                ];
                csvRows.push(values.join(','));
            }

            return csvRows.join('\n');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    });
</script>
</body>
</html>