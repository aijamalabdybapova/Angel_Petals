<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/header}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<head>
    <title>Корзина - Цветочный магазин</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="py-3">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/home}">Главная</a></li>
                <li class="breadcrumb-item"><a th:href="@{/bouquets}">Букеты</a></li>
                <li class="breadcrumb-item active">Корзина</li>
            </ol>
        </div>
    </nav>

    <!-- Cart Content -->
    <section class="py-4">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1 class="h2 mb-4">
                        <i class="fas fa-shopping-cart me-2"></i>Корзина покупок
                    </h1>
                </div>
            </div>


            <!-- Error Message -->
            <div class="row" th:if="${error}">
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span th:text="${error}"></span>
                    </div>
                </div>
            </div>

            <!-- Empty Cart -->
            <div class="row" th:if="${cart == null || cart.items.empty}">
                <div class="col-12">
                    <div class="card text-center py-5">
                        <div class="card-body">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <h3>Ваша корзина пуста</h3>
                            <p class="text-muted mb-4">Добавьте букеты, чтобы сделать заказ</p>
                            <a th:href="@{/bouquets}" class="btn btn-primary btn-lg">
                                <i class="fas fa-bouquet me-2"></i>Перейти к букетам
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart with Items -->
            <div class="row" th:if="${cart != null && !cart.items.empty}">
                <div class="col-lg-8">
                    <!-- Cart Items -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Товары в корзине</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th style="width: 100px;">Фото</th>
                                        <th>Букет</th>
                                        <th class="text-center">Цена</th>
                                        <th class="text-center">Количество</th>
                                        <th class="text-center">Сумма</th>
                                        <th class="text-center">Действия</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="item : ${cart.items}">
                                        <td>
                                            <img th:src="${item.bouquetImage != null} ?
                                                        @{'/uploads/' + ${item.bouquetImage}} :
                                                        @{/images/default-bouquet.jpg}"
                                                 class="rounded"
                                                 th:alt="${item.bouquetName}"
                                                 style="width: 80px; height: 80px; object-fit: cover;">
                                        </td>
                                        <td>
                                            <h6 class="mb-1" th:text="${item.bouquetName}">Название букета</h6>
                                            <small class="text-muted">Артикул: <span th:text="${item.bouquetId}">123</span></small>
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-bold"
                                                  th:text="'₽' + ${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 2, 'POINT')}">
                                                ₽2,500.00
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <div class="input-group input-group-sm" style="width: 120px;">
                                                <button class="btn btn-outline-primary"
                                                        type="button"
                                                        th:onclick="'updateQuantity(' + ${item.bouquetId} + ', -1)'">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number"
                                                       class="form-control text-center"
                                                       th:value="${item.quantity}"
                                                       th:id="'quantity-' + ${item.bouquetId}"
                                                       min="1"
                                                       max="99"
                                                       th:onchange="'updateQuantityInput(' + ${item.bouquetId} + ')'">
                                                <button class="btn btn-outline-primary"
                                                        type="button"
                                                        th:onclick="'updateQuantity(' + ${item.bouquetId} + ', 1)'">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-bold text-primary"
                                                  th:text="'₽' + ${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 2, 'POINT')}">
                                                ₽2,500.00
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <button class="btn btn-outline-danger btn-sm"
                                                    th:onclick="'removeFromCart(' + ${item.bouquetId} + ')'">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Continue Shopping -->
                    <div class="text-center">
                        <a th:href="@{/bouquets}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Продолжить покупки
                        </a>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Order Summary -->
                    <div class="card shadow-sm sticky-top" style="top: 20px;">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Сводка заказа</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Товары (<span th:text="${cart.totalItems}">0</span> шт.):</span>
                                <span th:text="'₽' + ${#numbers.formatDecimal(cart.totalAmount, 0, 'COMMA', 2, 'POINT')}">
                                    ₽2,500.00
                                </span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Доставка:</span>
                                <span class="text-success">Бесплатно</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Итого:</strong>
                                <strong class="h5 text-primary"
                                        th:text="'₽' + ${#numbers.formatDecimal(cart.totalAmount, 0, 'COMMA', 2, 'POINT')}">
                                    ₽2,500.00
                                </strong>
                            </div>

                            <div class="d-grid gap-2">
                                <a th:href="@{/orders/create}" class="btn btn-primary btn-lg">
                                    <i class="fas fa-credit-card me-2"></i>Перейти к оформлению
                                </a>
                                <button class="btn btn-outline-secondary" onclick="clearCart()">
                                    <i class="fas fa-trash me-2"></i>Очистить корзину
                                </button>
                            </div>

                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <small>
                                        <i class="fas fa-info-circle me-2"></i>
                                        Бесплатная доставка при заказе от ₽3,000
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    // Функции для работы с корзиной через API
    async function updateQuantity(bouquetId, change) {
        const quantityInput = document.getElementById('quantity-' + bouquetId);
        let newQuantity = parseInt(quantityInput.value) + change;

        if (newQuantity < 1) newQuantity = 1;
        if (newQuantity > 99) newQuantity = 99;

        await updateCartItem(bouquetId, newQuantity);
    }

    async function updateQuantityInput(bouquetId) {
        const quantityInput = document.getElementById('quantity-' + bouquetId);
        let newQuantity = parseInt(quantityInput.value);

        if (newQuantity < 1) newQuantity = 1;
        if (newQuantity > 99) newQuantity = 99;

        quantityInput.value = newQuantity;
        await updateCartItem(bouquetId, newQuantity);
    }

    async function updateCartItem(bouquetId, quantity) {
        try {
            const response = await fetch(`/api/cart/update/${bouquetId}?quantity=${quantity}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                location.reload(); // Перезагружаем страницу для обновления данных
            } else {
                alert('Ошибка при обновлении корзины: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при обновлении корзины');
        }
    }

    async function removeFromCart(bouquetId) {
        if (!confirm('Удалить товар из корзины?')) return;

        try {
            const response = await fetch(`/api/cart/remove/${bouquetId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                location.reload();
            } else {
                alert('Ошибка при удалении из корзины: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при удалении из корзины');
        }
    }

    async function clearCart() {
        if (!confirm('Очистить всю корзину?')) return;

        try {
            const response = await fetch('/api/cart/clear', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                location.reload();
            } else {
                alert('Ошибка при очистке корзины: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при очистке корзины');
        }
    }
</script>
</body>
</html>