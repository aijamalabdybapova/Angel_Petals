<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/header}">
<head>
    <title>Статистика - Админ панель</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Header -->
    <section class="py-4 bg-light">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h2 mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Статистика
                    </h1>
                    <p class="text-muted mb-0">Аналитика и отчеты по магазину</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="refreshStats">
                            <i class="fas fa-sync-alt me-2"></i>Обновить
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-success dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-download me-2"></i>Экспорт
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="exportReport('sales')">Продажи (CSV)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportReport('users')">Пользователи (CSV)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportReport('bouquets')">Букеты (CSV)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportReport('revenue')">Выручка (CSV)</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Date Range Filter -->
    <section class="py-3 border-bottom">
        <div class="container">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Начальная дата</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Конечная дата</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary mt-4 w-100" id="applyDateRange">
                        <i class="fas fa-filter me-2"></i>Применить
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary mt-4 w-100" id="resetDateRange">
                        <i class="fas fa-redo me-2"></i>Сбросить
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Statistics Cards -->
    <section class="py-4">
        <div class="container">
            <div class="row g-4">
                <!-- Total Revenue -->
                <div class="col-md-3">
                    <div class="card border-0 bg-success text-white shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="totalRevenue">
                                        ₽<span th:if="${stats.totalRevenue != null}"
                                               th:text="${#numbers.formatDecimal(stats.totalRevenue, 0, 'COMMA', 2, 'POINT')}">0</span>
                                        <span th:if="${stats.totalRevenue == null}">0</span>
                                    </h4>
                                    <p class="mb-0">Общая выручка</p>
                                </div>
                                <div class="icon-circle">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small>
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span id="revenueChange">0%</span> за период
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Orders -->
                <div class="col-md-3">
                    <div class="card border-0 bg-primary text-white shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="totalOrders">
                                        <span th:text="${stats.totalOrders != null ? stats.totalOrders : 0}">0</span>
                                    </h4>
                                    <p class="mb-0">Всего заказов</p>
                                </div>
                                <div class="icon-circle">
                                    <i class="fas fa-shopping-bag fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small>
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span id="ordersChange">0%</span> за период
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Users -->
                <div class="col-md-3">
                    <div class="card border-0 bg-info text-white shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="activeUsers">
                                        <span th:text="${stats.totalUsers != null ? stats.totalUsers : 0}">0</span>
                                    </h4>
                                    <p class="mb-0">Активных пользователей</p>
                                </div>
                                <div class="icon-circle">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small>
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span id="usersChange">0%</span> за период
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Average Order Value -->
                <div class="col-md-3">
                    <div class="card border-0 bg-warning text-white shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0" id="avgOrderValue">
                                        ₽<span th:if="${stats.totalOrders != null && stats.totalOrders > 0 && stats.totalRevenue != null}"
                                               th:text="${#numbers.formatDecimal(stats.totalRevenue / stats.totalOrders, 0, 'COMMA', 2, 'POINT')}">0</span>
                                        <span th:if="${stats.totalOrders == null || stats.totalOrders == 0}">0</span>
                                    </h4>
                                    <p class="mb-0">Средний чек</p>
                                </div>
                                <div class="icon-circle">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small>
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span id="avgOrderChange">0%</span> за период
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Charts and Detailed Statistics -->
    <section class="py-4">
        <div class="container">
            <div class="row g-4">
                <!-- Revenue Chart -->
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>Динамика выручки
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Status Distribution -->
                <div class="col-lg-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Статусы заказов
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="orderStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Popular Bouquets -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-star me-2"></i>Популярные букеты
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                    <tr>
                                        <th>Букет</th>
                                        <th class="text-end">Количество</th>
                                        <th class="text-end">Выручка</th>
                                    </tr>
                                    </thead>
                                    <tbody id="popularBouquets">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            Загрузка данных...
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Activity -->
                <div class="col-lg-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i class="fas fa-user-clock me-2"></i>Активность пользователей
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                    <tr>
                                        <th>Пользователь</th>
                                        <th class="text-end">Заказов</th>
                                        <th class="text-end">Сумма</th>
                                    </tr>
                                    </thead>
                                    <tbody id="userActivity">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            Загрузка данных...
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Detailed Reports -->
    <section class="py-4">
        <div class="container">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Детальный отчет по продажам
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="salesReportTable">
                            <thead>
                            <tr>
                                <th>Номер заказа</th>
                                <th>Дата</th>
                                <th>Клиент</th>
                                <th class="text-end">Сумма</th>
                                <th>Статус</th>
                                <th>Товары</th>
                            </tr>
                            </thead>
                            <tbody id="salesReportData">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <div class="spinner-border" role="status"></div>
                                    <p class="mt-2 mb-0">Загрузка отчета...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== ANALYTICS SCRIPT INITIALIZED ===');

        // Инициализация
        initializeDateRange();
        loadStatistics();
        setupEventListeners();

        // Тестирование API
        testAllAPIs();

        function initializeDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            console.log('Date range initialized');
        }

        function setupEventListeners() {
            document.getElementById('applyDateRange').addEventListener('click', loadStatistics);
            document.getElementById('resetDateRange').addEventListener('click', resetDateRange);
            document.getElementById('refreshStats').addEventListener('click', loadStatistics);
        }

        function resetDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            loadStatistics();
        }

        async function loadStatistics() {
            console.log('Loading statistics...');
            try {
                await Promise.all([
                    loadCharts(),
                    loadPopularBouquets(),
                    loadUserActivity(),
                    loadSalesReport()
                ]);
            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('Ошибка загрузки статистики', 'error');
            }
        }

        async function loadCharts() {
            try {
                // Revenue chart
                const revenueResponse = await fetch('/api/reports/monthly-revenue');
                if (revenueResponse.ok) {
                    const revenueResult = await revenueResponse.json();
                    if (revenueResult.success) {
                        renderRevenueChart(revenueResult.data);
                    }
                }

                // Order status chart
                const ordersResponse = await fetch('/api/orders?size=100');
                if (ordersResponse.ok) {
                    const ordersResult = await ordersResponse.json();
                    if (ordersResult.success) {
                        renderOrderStatusChart(ordersResult.data.content);
                    }
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        function renderRevenueChart(data) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;

            if (window.revenueChartInstance) {
                window.revenueChartInstance.destroy();
            }

            if (data && data.length > 0) {
                window.revenueChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(item => item.month_year),
                        datasets: [{
                            label: 'Выручка',
                            data: data.map(item => item.total_revenue),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₽' + value.toLocaleString('ru-RU');
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Показать сообщение об отсутствии данных
                ctx.getContext('2d').fillText('Нет данных для отображения', 10, 50);
            }
        }

        function renderOrderStatusChart(orders) {
            const ctx = document.getElementById('orderStatusChart');
            if (!ctx) return;

            if (window.orderStatusChartInstance) {
                window.orderStatusChartInstance.destroy();
            }

            const statusCount = {
                'PENDING': 0, 'CONFIRMED': 0, 'IN_PROGRESS': 0,
                'COMPLETED': 0, 'CANCELLED': 0
            };

            if (orders && orders.length > 0) {
                orders.forEach(order => {
                    statusCount[order.status] = (statusCount[order.status] || 0) + 1;
                });

                window.orderStatusChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ожидают', 'Подтверждены', 'В процессе', 'Завершены', 'Отменены'],
                        datasets: [{
                            data: Object.values(statusCount),
                            backgroundColor: ['#ffc107', '#17a2b8', '#007bff', '#28a745', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } else {
                ctx.getContext('2d').fillText('Нет данных для отображения', 10, 50);
            }
        }

        async function loadPopularBouquets() {
            try {
                const response = await fetch('/api/reports/bouquet-stats');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        renderPopularBouquets(result.data);
                        return;
                    }
                }
                document.getElementById('popularBouquets').innerHTML =
                    '<tr><td colspan="3" class="text-center text-muted py-3">Нет данных</td></tr>';
            } catch (error) {
                console.error('Error loading popular bouquets:', error);
                document.getElementById('popularBouquets').innerHTML =
                    '<tr><td colspan="3" class="text-center text-danger py-3">Ошибка загрузки</td></tr>';
            }
        }

        function renderPopularBouquets(bouquets) {
            const tbody = document.getElementById('popularBouquets');
            if (bouquets && bouquets.length > 0) {
                const sortedBouquets = bouquets
                    .sort((a, b) => (b.times_ordered || 0) - (a.times_ordered || 0))
                    .slice(0, 5);

                tbody.innerHTML = sortedBouquets.map(bouquet => `
                    <tr>
                        <td><strong>${bouquet.name || 'Неизвестный букет'}</strong></td>
                        <td class="text-end">${bouquet.times_ordered || 0}</td>
                        <td class="text-end">₽${formatNumber((bouquet.price || 0) * (bouquet.times_ordered || 0))}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Нет данных</td></tr>';
            }
        }

        async function loadUserActivity() {
            try {
                const response = await fetch('/api/reports/user-activity');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        renderUserActivity(result.data);
                        return;
                    }
                }
                document.getElementById('userActivity').innerHTML =
                    '<tr><td colspan="3" class="text-center text-muted py-3">Нет данных</td></tr>';
            } catch (error) {
                console.error('Error loading user activity:', error);
                document.getElementById('userActivity').innerHTML =
                    '<tr><td colspan="3" class="text-center text-danger py-3">Ошибка загрузки</td></tr>';
            }
        }

        function renderUserActivity(users) {
            const tbody = document.getElementById('userActivity');
            if (users && users.length > 0) {
                const activeUsers = users
                    .filter(user => user.total_orders > 0)
                    .sort((a, b) => b.total_spent - a.total_spent)
                    .slice(0, 5);

                tbody.innerHTML = activeUsers.map(user => `
                    <tr>
                        <td><strong>${user.username || 'Неизвестный пользователь'}</strong></td>
                        <td class="text-end">${user.total_orders || 0}</td>
                        <td class="text-end">₽${formatNumber(user.total_spent || 0)}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Нет данных</td></tr>';
            }
        }

        async function loadSalesReport() {
            try {
                const response = await fetch('/api/reports/sales');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        renderSalesReport(result.data);
                        return;
                    }
                }
                document.getElementById('salesReportData').innerHTML =
                    '<tr><td colspan="6" class="text-center text-muted py-4">Нет данных</td></tr>';
            } catch (error) {
                console.error('Error loading sales report:', error);
                document.getElementById('salesReportData').innerHTML =
                    '<tr><td colspan="6" class="text-center text-danger py-4">Ошибка загрузки</td></tr>';
            }
        }

        function renderSalesReport(sales) {
            const tbody = document.getElementById('salesReportData');
            if (sales && sales.length > 0) {
                tbody.innerHTML = sales.map(sale => `
                    <tr>
                        <td><strong>${sale.order_number || 'Нет номера'}</strong></td>
                        <td>${sale.order_date ? new Date(sale.order_date).toLocaleDateString('ru-RU') : 'Нет даты'}</td>
                        <td>${sale.customer || 'Неизвестный клиент'}</td>
                        <td class="text-end">₽${formatNumber(sale.total_amount || 0)}</td>
                        <td><span class="badge bg-${getStatusBadgeClass(sale.status)}">${getStatusText(sale.status)}</span></td>
                        <td><small>${sale.items_count || 0} шт.</small></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Нет данных</td></tr>';
            }
        }

        // Вспомогательные функции
        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(num);
        }

        function getStatusBadgeClass(status) {
            const statusClasses = {
                'PENDING': 'warning', 'CONFIRMED': 'info', 'IN_PROGRESS': 'primary',
                'COMPLETED': 'success', 'CANCELLED': 'danger'
            };
            return statusClasses[status] || 'secondary';
        }

        function getStatusText(status) {
            const statusTexts = {
                'PENDING': 'Ожидает', 'CONFIRMED': 'Подтвержден', 'IN_PROGRESS': 'В процессе',
                'COMPLETED': 'Завершен', 'CANCELLED': 'Отменен'
            };
            return statusTexts[status] || status;
        }

        function showNotification(message, type) {
            // Реализация уведомлений
            console.log('Notification:', type, message);
        }

        async function testAllAPIs() {
            console.log('Testing API endpoints...');
            const endpoints = [
                '/api/reports/monthly-revenue',
                '/api/reports/bouquet-stats',
                '/api/reports/user-activity',
                '/api/reports/sales',
                '/api/orders?size=100'
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint);
                    console.log(`${endpoint}: ${response.status}`);
                } catch (error) {
                    console.error(`${endpoint}: ERROR -`, error.message);
                }
            }
        }
    });
    /*]]>*/
</script>

<style>
    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-container {
        position: relative;
    }

    .card {
        transition: transform 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
    }
</style>


</body>
</html>



