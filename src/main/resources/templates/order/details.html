<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/header}">
<head>
    <title>Детали заказа - Цветочный магазин</title>
    <script>
        console.log('=== ORDER DETAILS PAGE LOADED ===');

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');

            // Update order status buttons
            const updateButtons = document.querySelectorAll('.update-order-status');
            console.log('Found update-order-status buttons:', updateButtons.length);

            updateButtons.forEach((button, index) => {
                console.log(`Button ${index + 1}:`, {
                    text: button.textContent.trim(),
                    orderId: button.getAttribute('data-order-id'),
                    status: button.getAttribute('data-status'),
                    visible: button.offsetParent !== null
                });

                button.addEventListener('click', function() {
                    console.log('=== BUTTON CLICKED ===');
                    const orderId = this.getAttribute('data-order-id');
                    const status = this.getAttribute('data-status');
                    console.log('Button clicked - orderId:', orderId, 'status:', status);
                    updateOrderStatus(orderId, status);
                });
            });

            // Check if user cancel button exists
            const userCancelBtn = document.querySelector('[onclick*="cancelOrder"]');
            if (userCancelBtn) {
                console.log('Found user cancel button:', userCancelBtn);
            }

            // Check authorization
            const adminSection = document.querySelector('[sec\\:authorize="hasAnyRole(\'ADMIN\')"]');
            console.log('Admin section found:', adminSection !== null);

            if (adminSection) {
                console.log('Admin section visible:', adminSection.offsetParent !== null);
            }
        });

        function updateOrderStatus(orderId, status) {
            const statusText = getStatusText(status);

            console.log('=== updateOrderStatus FUNCTION CALLED ===');
            console.log('Parameters:', { orderId, status, statusText });

            if (!confirm(`Вы уверены, что хотите изменить статус заказа на "${statusText}"?`)) {
                console.log('User cancelled the operation');
                return;
            }

            // Получаем CSRF токен
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            const url = `/api/orders/${orderId}/status?status=${status}`;
            console.log('Making POST request to:', url);

            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            };

            // Добавляем CSRF токен если есть
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch(url, {
                method: 'POST', // ИЗМЕНИТЕ С PUT НА POST
                headers: headers
            })
            .then(response => {
                console.log('Response received - status:', response.status, response.statusText);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response text:', text);
                        throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    showAlert(`Статус заказа изменен на "${statusText}"`, 'success');
                    setTimeout(() => {
                        console.log('Reloading page...');
                        location.reload();
                    }, 1500);
                } else {
                    showAlert('Ошибка при изменении статуса заказа: ' + (data.message || 'Неизвестная ошибка'), 'error');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showAlert('Ошибка при изменении статуса заказа: ' + error.message, 'error');
            });
        }

        function cancelOrder(orderId) {
            console.log('=== cancelOrder FUNCTION CALLED ===');
            console.log('Order ID:', orderId);

            if (!confirm('Вы уверены, что хотите отменить этот заказ?')) {
                console.log('User cancelled order cancellation');
                return;
            }

            // Получаем CSRF токен
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            const url = `/api/orders/${orderId}/status?status=CANCELLED`;
            console.log('Making POST request to:', url);

            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            };

            // Добавляем CSRF токен если есть
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch(url, {
                method: 'POST', // ИЗМЕНИТЕ С PUT НА POST
                headers: headers
            })
            .then(response => {
                console.log('Response received - status:', response.status, response.statusText);

                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response text:', text);
                        throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    showAlert('Заказ отменен', 'success');
                    setTimeout(() => {
                        console.log('Reloading page...');
                        location.reload();
                    }, 1500);
                } else {
                    showAlert('Ошибка при отмене заказа: ' + (data.message || 'Неизвестная ошибка'), 'error');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                showAlert('Ошибка при отмене заказа: ' + error.message, 'error');
            });
        }

        function getStatusText(status) {
            switch (status) {
                case 'PENDING': return 'Ожидает';
                case 'CONFIRMED': return 'Подтвержден';
                case 'IN_PROGRESS': return 'В процессе';
                case 'COMPLETED': return 'Завершен';
                case 'CANCELLED': return 'Отменен';
                default: return status;
            }
        }

        function showAlert(message, type) {
            console.log('Showing alert:', message, type);

            // Удаляем существующие алерты
            document.querySelectorAll('.alert.position-fixed').forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';

            const icon = type === 'success' ? 'check' : 'exclamation-triangle';
            alertDiv.innerHTML = `
                <i class="fas fa-${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Добавим проверку через 3 секунды после загрузки
        setTimeout(() => {
            console.log('=== POST-LOAD CHECK ===');
            const buttons = document.querySelectorAll('.update-order-status');
            console.log('Buttons after delay:', buttons.length);
            buttons.forEach(btn => console.log('Button:', btn.textContent.trim()));
        }, 3000);
    </script>
</head>
<body>
<div layout:fragment="content">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="py-3">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/home}">Главная</a></li>
                <li class="breadcrumb-item"><a th:href="@{/orders}">Мои заказы</a></li>
                <li class="breadcrumb-item active" th:text="'Заказ ' + ${order.orderNumber}">Заказ ORD-123456</li>
            </ol>
        </div>
    </nav>

    <!-- Order Details -->
    <section class="py-4">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Order Header -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h4 class="mb-0" th:text="'Заказ ' + ${order.orderNumber}">Заказ ORD-123456</h4>
                            <div class="btn-group">
                                <!-- ★★★★ ИСПРАВЛЕННАЯ СТРОКА - УБРАН ВЫЗОВ МЕТОДА ★★★★ -->
                                <span th:switch="${order.status}" class="badge fs-6">
                                    <span th:class="'badge ' + ${@orderController.getStatusBadgeClass(order.status)} + ' fs-6'"
                                          th:text="${@orderController.getStatusText(order.status)}">Ожидает</span>
                                    <span th:case="CONFIRMED" class="bg-info">Подтвержден</span>
                                    <span th:case="IN_PROGRESS" class="bg-primary">В процессе</span>
                                    <span th:case="COMPLETED" class="bg-success">Завершен</span>
                                    <span th:case="CANCELLED" class="bg-danger">Отменен</span>
                                    <span th:case="*" class="bg-secondary">Неизвестно</span>
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">Информация о заказе</h6>
                                    <p><strong>Дата создания:</strong>
                                        <span th:text="${#temporals.format(order.createdAt, 'dd.MM.yyyy HH:mm')}">
                                                01.01.2024 12:00
                                            </span>
                                    </p>
                                    <p><strong>Общая сумма:</strong>
                                        <span class="h5 text-primary"
                                              th:text="'₽' + ${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 2, 'POINT')}">
                                                ₽2,500.00
                                            </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">Информация о доставке</h6>
                                    <p><strong>Получатель:</strong>
                                        <span th:text="${order.recipientName}">Иван Иванов</span>
                                    </p>
                                    <p><strong>Телефон:</strong>
                                        <span th:text="${order.recipientPhone}">+7 (999) 123-45-67</span>
                                    </p>
                                    <p><strong>Адрес:</strong>
                                        <span th:text="${order.deliveryAddress}">г. Москва, ул. Примерная, д. 1</span>
                                    </p>
                                    <p th:if="${order.deliveryDate}">
                                        <strong>Дата доставки:</strong>
                                        <span th:text="${#temporals.format(order.deliveryDate, 'dd.MM.yyyy HH:mm')}">
                                                02.01.2024 14:00
                                            </span>
                                    </p>
                                </div>
                            </div>

                            <div th:if="${order.notes}" class="mt-3">
                                <h6 class="text-muted">Примечания:</h6>
                                <p class="text-muted" th:text="${order.notes}">
                                    Особые пожелания к заказу...
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Состав заказа
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th>Букет</th>
                                        <th class="text-center">Количество</th>
                                        <th class="text-end">Цена</th>
                                        <th class="text-end">Сумма</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="item : ${order.orderItems}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img th:src="${item.bouquet.imageUrl != null} ?
                                                            @{'/uploads/' + ${item.bouquet.imageUrl}} :
                                                            @{/images/default-bouquet.jpg}"
                                                     class="rounded me-3"
                                                     th:alt="${item.bouquet.name}"
                                                     style="width: 60px; height: 60px; object-fit: cover;">
                                                <div>
                                                    <h6 class="mb-1" th:text="${item.bouquet.name}">Название букета</h6>
                                                    <small class="text-muted"
                                                           th:if="${item.bouquet.category != null}"
                                                           th:text="${item.bouquet.category.name}">
                                                        Категория
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center" th:text="${item.quantity}">1</td>
                                        <td class="text-end"
                                            th:text="'₽' + ${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 2, 'POINT')}">
                                            ₽2,500.00
                                        </td>
                                        <td class="text-end"
                                            th:text="'₽' + ${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 2, 'POINT')}">
                                            ₽2,500.00
                                        </td>
                                    </tr>
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Итого:</strong></td>
                                        <td class="text-end">
                                            <strong th:text="'₽' + ${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 2, 'POINT')}">
                                                ₽2,500.00
                                            </strong>
                                        </td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Order Actions -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>Действия
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a th:href="@{/orders}" class="btn btn-outline-primary">
                                    <i class="fas fa-arrow-left me-2"></i>К списку заказов
                                </a>

                                <!-- Manager/Admin Actions -->
                                <div sec:authorize="hasAnyRole('ADMIN')" class="mt-3">
                                    <h6 class="text-muted mb-3">Управление заказом</h6>

                                    <div class="btn-group w-100 mb-2">
                                        <button th:if="${order.status?.name() == 'PENDING'}"
                                                class="btn btn-outline-success update-order-status"
                                                th:data-order-id="${order.id}"
                                                data-status="CONFIRMED">
                                            <i class="fas fa-check me-2"></i>Подтвердить
                                        </button>
                                        <button th:if="${order.status?.name() == 'CONFIRMED'}"
                                                class="btn btn-outline-info update-order-status"
                                                th:data-order-id="${order.id}"
                                                data-status="IN_PROGRESS">
                                            <i class="fas fa-spinner me-2"></i>В процессе
                                        </button>
                                    </div>

                                    <div class="btn-group w-100 mb-2">
                                        <button th:if="${order.status?.name() == 'IN_PROGRESS'}"
                                                class="btn btn-outline-success update-order-status"
                                                th:data-order-id="${order.id}"
                                                data-status="COMPLETED">
                                            <i class="fas fa-flag me-2"></i>Завершить
                                        </button>
                                        <button th:if="${order.status?.name() != 'CANCELLED' && order.status?.name() != 'COMPLETED'}"
                                                class="btn btn-outline-danger update-order-status"
                                                th:data-order-id="${order.id}"
                                                data-status="CANCELLED">
                                            <i class="fas fa-times me-2"></i>Отменить
                                        </button>
                                    </div>
                                </div>

                                <!-- User Actions -->
                                <div sec:authorize="hasRole('USER')" class="mt-3">
                                    <button th:if="${order.status?.name() == 'PENDING'}"
                                            class="btn btn-outline-danger"
                                            th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        <i class="fas fa-times me-2"></i>Отменить заказ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Timeline -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>История статусов
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="timeline-item" th:classappend="${order.status?.name() == 'PENDING'} ? 'active' : ''">
                                    <div class="timeline-marker bg-warning"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Ожидание подтверждения</h6>
                                        <small class="text-muted" th:text="${#temporals.format(order.createdAt, 'dd.MM.yyyy HH:mm')}">
                                            01.01.2024 12:00
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item" th:classappend="${order.status?.name() == 'CONFIRMED'} ? 'active' : ''">
                                    <div class="timeline-marker bg-info"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Подтвержден</h6>
                                        <small class="text-muted" th:if="${order.status?.name() == 'CONFIRMED'}"
                                               th:text="${#temporals.format(order.updatedAt, 'dd.MM.yyyy HH:mm')}">
                                            01.01.2024 12:30
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item" th:classappend="${order.status?.name() == 'IN_PROGRESS'} ? 'active' : ''">
                                    <div class="timeline-marker bg-primary"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">В процессе доставки</h6>
                                        <small class="text-muted" th:if="${order.status?.name() == 'IN_PROGRESS'}"
                                               th:text="${#temporals.format(order.updatedAt, 'dd.MM.yyyy HH:mm')}">
                                            01.01.2024 13:00
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item" th:classappend="${order.status?.name() == 'COMPLETED'} ? 'active' : ''">
                                    <div class="timeline-marker bg-success"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Завершен</h6>
                                        <small class="text-muted" th:if="${order.status?.name() == 'COMPLETED'}"
                                               th:text="${#temporals.format(order.updatedAt, 'dd.MM.yyyy HH:mm')}">
                                            01.01.2024 14:00
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item" th:classappend="${order.status?.name() == 'CANCELLED'} ? 'active' : ''">
                                    <div class="timeline-marker bg-danger"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Отменен</h6>
                                        <small class="text-muted" th:if="${order.status?.name() == 'CANCELLED'}"
                                               th:text="${#temporals.format(order.updatedAt, 'dd.MM.yyyy HH:mm')}">
                                            01.01.2024 12:15
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-item.active .timeline-marker {
        border: 3px solid #fff;
        box-shadow: 0 0 0 3px var(--bs-primary);
    }

    .timeline-marker {
        position: absolute;
        left: -30px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #6c757d;
    }

    .timeline-content {
        padding-bottom: 10px;
    }
</style>


</body>
</html>